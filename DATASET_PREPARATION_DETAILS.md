# データセット準備プロセス詳細

## 概要

本文書では、gRPC Protocol Buffers自動修正システムの評価用データセット準備における詳細なプロセスとフィルタリング基準について説明する。

## 1. データセット準備のフロー

| 段階 | 入力 | 処理 | 出力 | 目的 |
|:--:|:--|:--|:--|:--|
| 1 | P.U_merged...csv | gRPCプロジェクト抽出 | gRPC利用確認済み | 対象範囲特定 |
| 2 | gRPC確認済み | .proto変更検出 | .proto diff | 関連性確認 |
| 3 | .proto diff | dataset_few_changed.js | filtered_fewChanged | 評価用最適化 |

## 2. 段階別詳細プロセス

### 2.1 Stage 1: 初期データセット分析

#### 入力データ
**ファイル**: `P.U_merged_filtered - Final_merged_only_not_excluded_yes_ms_unarchived_commit_hash v2.0.csv`

#### データ特性
- **対象**: GitHubプロジェクトのIssue/Pull Requestメタデータ
- **フィルタ済み**: マイクロサービス関連、アーカイブ済み除外、コミットハッシュ付き
- **規模**: 数千〜数万件のレコード
- **品質**: 事前検証済み、重複除去済み

#### 含有情報
- リポジトリ名・オーナー情報
- Issue/Pull Request番号・タイトル
- コミットハッシュ（変更前後）
- マイクロサービス関連度スコア
- プロジェクトメタデータ

### 2.2 Stage 2: gRPCプロジェクト抽出

#### 抽出基準
| カテゴリ | 項目 | 詳細 | 重要度 |
|:--|:--|:--|:--:|
| **gRPCライブラリ依存関係** | Go | google.golang.org/grpc | 必須 |
| | Java | io.grpc:grpc-* | 必須 |
| | Python | grpcio, grpcio-tools | 必須 |
| | C++ | grpc++, protobuf | 必須 |
| **Protocol Buffers確認** | .protoファイル | 存在確認 | 必須 |
| | protocコンパイラ | 使用痕跡 | 推奨 |
| | 生成ファイル | パターン確認 | 推奨 |
| **プロジェクト活動度** | 最終コミット | 1年以内 | 必須 |
| | Issue/PR数 | 最低閾値以上 | 必須 |
| | コントリビューター | 2人以上 | 推奨 |

### 2.3 Stage 3: .proto変更検出とクローン

#### 使用ツール
| ツール名 | 場所 | 機能 | 対象ファイル |
|:--|:--|:--|:--|
| filterDatasets.js | app/filterDatasets.js | .proto変更検出 | .protoファイル |

#### 処理ロジック
| 処理段階 | 対象 | 実行内容 | 結果 |
|:--|:--|:--|:--|
| フィルタ条件設定 | .protoファイル | 変更対象ファイル特定 | filter配列 |
| 変更検出 | premerge/merge | 差分ファイル取得 | changedFiles |
| フィルタリング | changedFiles | .proto含有確認 | filteredChangedFiles |

#### ディレクトリ構造生成
| レベル | パス例 | 説明 | 必須性 |
|:--:|:--|:--|:--:|
| 1 | dataset/filtered_commit/ | 基本ディレクトリ | 必須 |
| 2 | {repository_name}/ | プロジェクト別 | 必須 |
| 3 | pullrequest/ または issue/ | タイプ別分類 | 必須 |
| 4 | {issue_or_pr_title}/ | 個別ケース | 必須 |
| 5 | premerge_{commit_hash}/ | 変更前スナップショット | 必須 |
| 6 | merge_{commit_hash}/ | 変更後スナップショット | 必須 |
| 7 | commit_snapshot_{hash}/ | 追加スナップショット | 任意 |

#### 品質保証
| 検証項目 | 確認内容 | 失敗時の対応 | 重要度 |
|:--|:--|:--|:--:|
| スナップショット存在 | premerge/merge両方あり | ケース除外 | 必須 |
| .proto変更検証 | 実際の差分確認 | 変更なしで除外 | 必須 |
| ファイル完整性 | 破損・不完全チェック | 該当ファイル除外 | 必須 |

### 2.4 Stage 4: 微細変更フィルタリング

#### 実行スクリプト
**ファイル**: `src/Tools/dataset_few_changed.js`

#### 主要パラメータ
```javascript
// 数値制限
const ignoredChangedFileNum = 7;      // ファイル変更数上限
const ignoredChangedNum = 30;         // 1ファイルあたり行変更数上限
const countDeletedFiles = false;      // 削除ファイル除外

// 入出力パス
const inputDataSetDirPath = '/app/dataset/filtered_commit';
const outputDataSetDirPath = '/app/dataset/filtered_fewChanged';
```

## 3. 除外ルール詳細分析

### 3.1 APR実験用除外の理論的根拠

#### 自動生成ファイル除外の理由
1. **決定論的生成**: Protocol Buffers生成ファイルは入力.protoから機械的に生成
2. **修正不要**: 手動修正が不要かつ不適切
3. **ノイズ除去**: 実際のロジック変更に集中するため

#### 依存関係ファイル除外の理由
1. **メタデータ性質**: コードロジックではなく環境設定
2. **自動更新**: 多くが自動更新またはツール生成
3. **APR対象外**: プログラム修復の主要対象ではない

### 3.2 除外パターンの技術的詳細

#### Protocol Buffers関連除外ファイル
| 言語 | 拡張子 | 説明 | 除外理由 |
|:--|:--|:--|:--|
| Go | .pb.go | Go protobuf生成ファイル | 自動生成 |
| Go | _grpc.pb.go | Go gRPC生成ファイル | 自動生成 |
| C++ | .pb.cc | C++ protobuf実装 | 自動生成 |
| C++ | .pb.h | C++ protobufヘッダー | 自動生成 |
| C++ | _grpc.pb.cc | C++ gRPC実装 | 自動生成 |
| C++ | _grpc.pb.h | C++ gRPCヘッダー | 自動生成 |
| Java | .pb.java | Java protobuf生成ファイル | 自動生成 |
| Python | .pb.py | Python protobuf生成ファイル | 自動生成 |

#### パターンマッチング
| パターンタイプ | 正規表現/文字列 | 説明 | 対象例 |
|:--|:--|:--|:--|
| パス含有（大小文字不問） | /generated/i | "generated"含むパス | src/generated/api.go |
| パス含有（大小文字不問） | /auto-generated/i | "auto-generated"含む | auto-generated/proto/ |
| ファイル名パターン | /_generated\./ | "_generated."含む | data_generated.pb.go |
| ファイル名パターン | /\.gen\./ | ".gen."含む | api.gen.java |
| Goモックファイル | /mock_.*\.go$/ | mock_*.go形式 | mock_service.go |
| Goモックファイル | /.*_mock\.go$/ | *_mock.go形式 | service_mock.go |
| 汎用モックファイル | /.*\.mock\./ | *.mock.*形式 | api.mock.js |

#### ディレクトリレベル除外
| ディレクトリ | 言語/用途 | 除外理由 | 影響範囲 |
|:--|:--|:--|:--|
| vendor/ | Go | 依存関係管理 | Go プロジェクト |
| node_modules/ | Node.js | パッケージ管理 | JavaScript/TypeScript |
| third_party/ | 汎用 | サードパーティ | 全言語 |
| external/ | 汎用 | 外部依存 | 全言語 |
| .git/ | Git | バージョン管理 | 全プロジェクト |
| .github/ | GitHub | CI/CD設定 | GitHub プロジェクト |
| dist/ | ビルド | 配布用出力 | 全言語 |
| build/ | ビルド | ビルド出力 | 全言語 |
| target/ | Java | Maven/Gradle | Java プロジェクト |
| bin/ | バイナリ | 実行ファイル | 全言語 |
| obj/ | バイナリ | オブジェクト | C/C++ |

## 4. フィルタリング品質評価

### 4.1 定量的指標

#### 変更規模制限の効果
```
| 指標 | フィルタリング前 | フィルタリング後 | 効果 |
|:--|:--:|:--:|:--|
| **平均ファイル変更数** | 50-100ファイル | 3-7ファイル | 大規模→小規模修正 |
| **平均行変更数** | 100-500行 | 10-30行 | 機能追加→バグ修正レベル |
| **総ファイル数** | 150-300ファイル | 20-50ファイル | 約70-80%除外 |

#### 除外効果の内訳
| 除外カテゴリ | 除外率 | 対象例 | 効果 |
|:--|:--:|:--|:--|
| 自動生成ファイル | 40-60% | .pb.go, .pb.java | ノイズ除去 |
| 設定・メタデータ | 20-30% | package.json, pom.xml | 論理分離 |
| 開発環境ファイル | 10-15% | .github/, vendor/ | 環境固有除外 |

### 4.2 質的評価

#### 人手修正パターンとの類似性
| 比較項目 | フィルタリング後 | 人間の修正パターン | 類似度 |
|:--|:--|:--|:--:|
| **修正範囲** | 論理的関連変更のみ | 1回のコミット規模 | 高 |
| **修正内容** | .protoトリガー変更 | 目的明確な変更 | 高 |
| **修正複雑度** | 理解可能レベル | 段階的な変更 | 高 |

#### APR適用性向上
| 改善項目 | 効果 | 測定方法 | 重要度 |
|:--|:--|:--|:--:|
| **明確な修正目標** | .protoファイル変更トリガー | 成功率向上 | 高 |
| **影響範囲限定** | 関連ファイルのみ | エラー率低下 | 高 |
| **検証可能性** | 修正結果妥当性 | 品質向上 | 中 |
```

#### 除外効果
```
除外前の平均ファイル数: 150-300ファイル
除外後の平均ファイル数: 20-50ファイル
除外率: 約70-80%

ノイズ除去効果:
- 自動生成ファイル: 40-60%除外
- 設定・メタデータ: 20-30%除外
- 開発環境ファイル: 10-15%除外
```

### 4.2 質的評価

#### 人手修正パターンとの類似性
1. **修正範囲**: 人間の1回のコミットに類似した規模
2. **修正内容**: 論理的に関連する変更のみ
3. **修正複雑度**: 理解可能なレベルの変更

#### APR適用性向上
1. **明確な修正目標**: .protoファイル変更という明確なトリガー
2. **影響範囲限定**: 関連ファイルのみに修正が限定
3. **検証可能性**: 修正結果の妥当性を検証しやすい

## 5. データセット統計情報

### 5.1 処理統計例

#### Stage間での減少率
```
初期CSV: 10,000 レコード
↓ gRPCフィルタ後: 2,500 レコード (25%選択)
↓ .proto変更検出後: 800 レコード (8%選択)
↓ 微細変更フィルタ後: 200 レコード (2%選択)
```

#### 最終データセット特性
```
- 平均ファイル変更数: 4.2ファイル
- 平均行変更数: 18.7行
- .protoファイル変更率: 100%
- 手動コード変更率: 60-80%
- 自動生成ファイル変更率: 0%
```

### 5.2 品質指標

#### データセット多様性
- **言語分布**: Go(40%), Java(25%), Python(20%), C++(15%)
- **プロジェクト規模**: Small(30%), Medium(50%), Large(20%)
- **変更タイプ**: 新機能(40%), バグ修正(35%), リファクタリング(25%)

#### APR適用可能性
- **成功率予想**: 70-85% (小規模変更による高い成功率)
- **失敗原因予想**: 複雑なロジック変更(60%), コンテキスト不足(40%)

## 6. 制限事項と考慮点

### 6.1 フィルタリングの制限

#### 過度な制限による制約
- **多様性の減少**: 大規模変更パターンの除外
- **現実性の低下**: 実際の開発では大規模変更も頻発
- **評価の偏向**: 特定のパターンのみでの評価

#### 除外ルールの限界
- **静的判定**: ファイル名・パスのみによる判定
- **誤分類**: 重要な手動ファイルの誤除外の可能性
- **言語依存**: 特定プログラミング言語に特化したルール

### 6.2 実験妥当性への影響

#### 外的妥当性
- **一般化可能性**: 実世界の多様な変更パターンへの適用可能性
- **規模スケーラビリティ**: より大規模なプロジェクトでの動作

#### 内的妥当性
- **測定精度**: フィルタリング基準の妥当性
- **再現性**: 同一条件での結果再現性
