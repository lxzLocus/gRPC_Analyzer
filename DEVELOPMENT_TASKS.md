# LLMFlowController 開発タスク管理

## 🎯 プロジェクト概要
gRPCバグ修正用のLLM自動応答システムの完成を目指す

## 📋 開発優先順位別タスク

### 🚨 Phase 1: 基盤整備（最優先）✅ **完了**
**現状**: ✅ **Phase 1 完了！** コードが大幅に改善され、ファイル分割も実施済み

#### Task 1-1: 未実装メソッドの基本実装 ✅ **完了**
- [x] `llmReanalyze()` - LLM応答の再解析処理
- [x] `systemParseDiff()` - diff解析処理
- [x] `sendResultToLLM()` - 適用結果送信処理
- [x] `llmNextStep()` - 次ステップ実行処理
- [x] `sendErrorToLLM()` - エラー情報送信処理
- [x] `llmErrorReanalyze()` - エラー再解析処理

#### Task 1-2: 型定義の改善 ✅ **完了**
- [x] `Context`型の詳細化
- [x] `LLMParsed`型の拡張
- [x] エラーハンドリングの型安全性向上
- [x] 型定義の独立ファイル化 (`types.ts`)

#### Task 1-3: 動的インポートの修正 ✅ **完了**
- [x] `generatePeripheralStructure.js`のインポート方法を型安全に修正
- [x] RestoreDiffクラスのインポート確認

#### Task 1-4: ファイル構造の改善 ✅ **新規追加・完了**
- [x] クラス定義の分離 (`config.ts`, `messageHandler.ts`, `fileManager.ts`, `openAIClient.ts`)
- [x] 型定義の独立化 (`types.ts`)
- [x] 可読性とメンテナンス性の向上

### 🔧 Phase 2: コア機能実装
**現状**: 基盤が整ったので実装を開始可能

#### Task 2-1: LLM応答解析の強化
- [ ] `analyzeMessages()`メソッドの改良
- [ ] タグ解析ロジックの堅牢化
- [ ] 解析エラー時の回復処理

#### Task 2-2: プロンプト管理の改善
- [ ] Handlebarsテンプレートの検証
- [ ] プロンプトファイルの存在確認
- [ ] テンプレート変数の型安全性

#### Task 2-3: ファイル操作の堅牢化
- [ ] `getFileContent()`のエラーハンドリング強化
- [ ] `getDirectoryListing()`の例外処理改善
- [ ] ファイル存在確認の最適化

### 🎯 Phase 3: 高度な機能実装
**現状**: Phase 2完了後に着手

#### Task 3-1: 状態遷移の最適化
- [ ] `systemAnalyzeRequest()`でのファイル/ディレクトリ判定ロジック
- [ ] `checkApplyResult()`での詳細な結果判定
- [ ] 循環参照の防止機構

#### Task 3-2: diff適用システムの改善
- [ ] `systemApplyDiff()`の信頼性向上
- [ ] 適用前のバックアップ機構
- [ ] 適用結果の検証システム

#### Task 3-3: ログシステムの完成
- [ ] `Logger`クラスとの連携強化
- [ ] ログフォーマットの統一
- [ ] エラーログの詳細化

### 🚀 Phase 4: 統合テスト・最適化
**現状**: Phase 3完了後に着手

#### Task 4-1: 統合テストの実装
- [ ] モックLLMを使用した単体テスト
- [ ] 実際のプロジェクトでの統合テスト
- [ ] エラーケースのテスト

#### Task 4-2: パフォーマンス最適化
- [ ] メモリ使用量の最適化
- [ ] 大きなファイルの分割処理
- [ ] タイムアウト処理の実装

#### Task 4-3: 設定管理の改善
- [ ] 設定ファイルの外部化
- [ ] 環境変数の活用
- [ ] デバッグモードの実装

## 🎯 次に着手すべきタスク

### 最優先: Task 2-1 の `analyzeMessages()` 改良
- タグ解析ロジックの信頼性向上
- 不正なメッセージ形式への対応
- パースエラー時の詳細なログ出力

### 次優先: Task 2-2 の プロンプト管理改善
- プロンプトファイルの存在確認
- テンプレート変数の検証
- エラー時のフォールバック処理

## 📊 進捗管理

- [x] Phase 1 完了 (基盤整備) ✅
- [ ] Phase 2 完了 (コア機能)
- [ ] Phase 3 完了 (高度な機能)
- [ ] Phase 4 完了 (統合テスト)

## 💡 実装のヒント

1. **ファイル分割の効果**: クラスが独立したことで、単体テストや個別の修正が容易になった
2. **型安全性**: 共通の型定義により、IDE の補完とエラー検出が向上
3. **段階的実装**: Phase 1の完了により、残りの実装が効率的に進められる
4. **保守性**: 各クラスが責任分離されたため、機能追加や修正が容易

## 🎉 Phase 1 達成内容

**ファイル構成**:
- `/app/app/module/llmFlowController.ts` - メインコントローラー (約350行)
- `/app/app/module/config.ts` - 設定管理クラス
- `/app/app/module/messageHandler.ts` - メッセージ処理クラス
- `/app/app/module/fileManager.ts` - ファイル管理クラス
- `/app/app/module/openAIClient.ts` - OpenAI API クライアント
- `/app/app/module/types.ts` - 型定義

**改善点**:
- 777行 → 約350行（メインファイル）
- 可読性の大幅向上
- 型安全性の改善
- メンテナンス性の向上
- 責任分離の実現

---


